graph TD
    %% 主入口
    A[用户输入] --> B{意图识别：津贴&参团卡相关意图？}
    
    %% 单轮对话：进入场景1（领取津贴或参团卡）
    B -- 是领取津贴/参团卡请求 --> C[场景1：领取津贴或参团卡]
    C --> D[发放津贴或参团卡至账户]
    D --> E[回复用户并引导发送商品]
    E --> F[结束当前子级工作流]

    %% 多轮对话：进入场景2（商品优惠计算）
    B -- 是商品优惠计算请求 --> G[场景2：商品优惠计算]
    G --> H[解析商品信息]
    H --> I[询问购买数量]
    I --> J{用户回复数量了吗？}

    %% 用户回复数量，继续优惠计算流程
    J -- 是 --> K[随机选择优惠计算]
    K --> L[生成代下单卡片]
    L --> M[回复用户并引导付款]
    M --> F[结束当前子级工作流]

    %% 用户未回复数量，进入异常处理逻辑
    J -- 否 --> N{用户提出了问题？}
    
    %% 判断问题是否相关
    N -- 是相关问题 --> O[回答问题并引导用户下单]
    O --> I  %% 回到询问数量节点，继续流程

    N -- 否，非相关问题 --> P[结束当前子级工作流并保存上下文]
    P --> B %% 回到意图识别模块回答用户问题

    %% 回到意图识别模块后，判断用户是否回到商品优惠计算工作流
    B -- 用户在规定次数内回复 --> G %% 重新激活商品优惠计算流程
    B -- 用户跳出津贴&参团卡工作流 --> F %% 不再激活商品优惠计算工作流，结束工作流

    %% 单轮对话：进入场景3（咨询津贴或参团卡使用）
    B -- 是津贴/参团卡咨询 --> Q[场景3：咨询津贴或参团卡使用]
    Q --> R[提供津贴或参团卡使用说明]
    R --> F[结束当前子级工作流]

    %% 非津贴/参团卡意图
    B -- 非津贴/参团卡意图 --> S[结束当前工作流并转接新意图]


模块1：意图识别与分支判断
1. 模块概述
1.1 模块名称
意图识别与分支判断
1.2 模块描述
该模块的主要任务是分析用户输入内容，使用大语言模型（LLM）识别用户的意图，并为不同意图的分支模块下发相应指令。意图识别模块作为津贴&参团卡工作流的“大脑”，识别用户的具体需求，决定进入合适的分支场景，并下发相应指令以供分支模块执行。
1.3 模块目标
高效识别用户意图，并下发清晰的指令，确保每个分支模块能够准确执行任务，为用户提供最优的优惠体验。
2. 功能需求
2.1 用户意图识别
触发条件
用户输入：用户发起对话，输入任何优惠相关或其他意图的信息。
识别逻辑
意图分类：基于用户输入内容，使用LLM系统将意图识别分类为以下四种情况：
领取津贴或参团卡（场景1）。
商品优惠计算（场景2）。
咨询津贴或参团卡的规则（场景3）。
其他非津贴&参团卡意图：直接退出津贴&参团卡工作流，进入其他意图流程。
输出
意图识别输出：将识别结果传递给分支判断模块，以便根据识别出的用户意图进入不同的分支场景。
2.2 指令下发逻辑
流程入口
触发条件：用户意图识别后，意图识别模块下发指令至相应的场景模块。
逻辑路径及指令字段设计
路径1：领取津贴或参团卡

进入场景1：当用户输入明确表达“领取津贴”或“领取参团卡”时，系统进入场景1。
指令字段：
指令类型：领取优惠
优惠种类：津贴或参团卡（由用户请求决定）
优惠金额：200元（默认）
路径2：商品优惠计算

进入场景2：当用户的输入内容为商品信息时，系统进入场景2。
指令字段：
指令类型：商品优惠计算
商品信息：商品ID、商品名称、价格等
优惠选择：随机（随机选择津贴或参团卡）
路径3：咨询津贴或参团卡的规则

进入场景3：当用户的输入内容为津贴或参团卡的使用规则咨询时，系统进入场景3。
指令字段：
指令类型：咨询规则
咨询内容类别：津贴或参团卡规则（例如领取条件、使用条件等）
路径4：非津贴&参团卡意图

结束当前工作流：当用户意图识别为非津贴&参团卡的内容时，系统直接结束当前工作流。
指令字段：
指令类型：退出工作流
跳转意图：转入其他意图流程
状态标记：记录为非津贴相关的工作流结束标记
3. 输出指令字段设计
每个意图对应的指令字段如下：

意图分类	指令类型	指令字段
领取津贴或参团卡	领取优惠	优惠种类：津贴/参团卡，优惠金额：200元
商品优惠计算	商品优惠计算	商品信息（商品ID、名称、价格等），优惠选择：随机
咨询津贴或参团卡的规则	咨询规则	咨询内容类别：津贴/参团卡规则（领取条件、使用条件等）
非津贴&参团卡意图	退出工作流	跳转意图：其他流程，状态标记：非津贴&参团卡流程结束


PRD 模块2：场景1 - 领取津贴或参团卡
1. 模块概述
1.1 模块名称
场景1：领取津贴或参团卡
1.2 模块描述
场景1模块的任务是根据意图识别模块下发的指令内容，向用户账户发放津贴或参团卡。在接收到领取优惠的指令后，系统将按照指令中指定的优惠类型（津贴或参团卡）和金额，将优惠直接发放至用户账户。
1.3 模块目标
在用户发起领取津贴或参团卡的请求时，高效、准确地将优惠发放至用户账户并反馈发放成功信息。
2. 功能需求
2.1 优惠发放逻辑
触发条件
指令接收：当场景1模块接收到意图识别模块下发的指令，且指令类型为“领取优惠”时，系统将自动进入该流程。
执行步骤
优惠种类判断：
系统根据指令字段中的“优惠种类”来判断是津贴还是参团卡，并选择相应的发放流程。
发放优惠：
津贴发放：若“优惠种类”为津贴，系统在用户账户中添加200元津贴，津贴金额固定。
参团卡发放：若“优惠种类”为参团卡，系统在用户账户中直接添加参团卡。
反馈用户：
发放成功后，系统发送反馈话术给用户，确认津贴或参团卡已发放成功（具体话术详见下方话术模板）。
结束条件
完成优惠发放和反馈后，场景1工作流结束，等待用户进一步输入或操作。
3. 输出指令字段设计
3.1 场景1接收的指令字段
场景1模块接收以下指令字段：

字段名称	字段描述	示例值
指令类型	确认任务类型	领取优惠
优惠种类	用户请求的优惠种类	津贴/参团卡
优惠金额	若优惠类型为津贴，指示发放金额	200（固定）
3.2 场景1执行后的反馈
场景1执行完毕后，将生成以下反馈信息发送给用户：

字段名称	字段描述	示例值
优惠发放状态	表示优惠发放成功与否	成功/失败
优惠类型	表示发放的优惠类型	津贴/参团卡
优惠金额	表示发放的优惠金额	200（固定值，如适用）
用户反馈话术ID	系统反馈话术模板的唯一标识符	话术ID或具体话术内容
4. 话术模板
4.1 用户反馈话术
津贴发放成功：

“已为您发放200元津贴到您的账户中，请查看账户余额以确认。”
参团卡发放成功：

“已为您发放参团卡，请查看账户中的参团卡信息，享受团购优惠。”
发放失败（兜底话术）：

“抱歉，津贴或参团卡的发放遇到问题，请稍后再试或联系客服解决。”
5. 异常处理
5.1 优惠发放失败
触发条件：若优惠发放操作遇到系统问题或账户状态异常，导致优惠未成功发放。
执行步骤：
系统记录错误信息并生成用户反馈话术。
将失败情况反馈给用户，提示用户稍后再试或联系人工客服。
反馈话术：参考话术模板中的发放失败话术。

PRD 模块3：场景2 - 商品优惠计算
1. 模块概述
1.1 模块名称
场景2：商品优惠计算
1.2 模块描述
场景2的任务是接收商品信息，完成多轮对话的优惠计算流程。在计算出最终优惠金额后，系统生成代下单卡片，并将卡片发送给用户。此流程在卡片发送完成后即告结束。
1.3 模块目标
在用户发起商品优惠计算请求时，灵活地进行多轮对话，获取必要信息并根据最优方案计算出优惠金额，生成下单信息并反馈给用户。
2. 功能需求
2.1 商品信息确认
触发条件
指令接收：当场景2模块接收到意图识别模块下发的指令，且指令类型为“商品优惠计算”时，系统直接进入该流程。
执行步骤
商品信息确认：
系统从指令字段中提取商品ID、商品名称、价格等基本信息。
商品信息无需额外验证，默认完整，直接进入数量询问流程。
输出
商品详情数据：包括商品ID、名称和价格，作为后续优惠计算的数据支撑。
2.2 询问用户购买数量
触发条件
商品信息确认完成：商品信息解析并记录后，系统进入数量询问流程。
执行步骤
数量询问：
系统向用户发送询问话术，要求用户提供购买数量，例如：“请问您要购买几件呢？”
等待用户回复并判断回复类型：
LLM判断用户回复类型：接收到用户回复后，使用 LLM 模型判断回复内容是否为数量：
如果回复为数量：将数量值传递给系统，进入优惠计算流程。
如果回复为其他问题：直接转交意图识别模块处理。
输出
数量信息：用户回复的购买数量，用于后续的优惠计算。
2.3 优惠计算逻辑
触发条件
数量信息接收：系统接收到用户回复的购买数量后，进入优惠计算流程。
执行步骤
优惠类型选择：
系统根据“优惠选择”字段设置，随机选择“津贴”或“参团卡”优惠。
计算优惠金额：
根据商品价格、购买数量和选择的优惠类型计算优惠金额。
津贴优惠：例如总价的10%作为优惠金额，最多200元。
参团卡优惠：总价的15%作为优惠金额。
生成代下单卡片：
计算完成后，系统生成带有最终支付金额的代下单卡片，卡片内容包括以下信息：
商品名称
原价、优惠金额、最终支付金额
下单按钮或卡片
输出
下单卡片：显示商品详情、计算后的优惠信息和最终支付金额。
2.4 用户反馈（流程结束）
触发条件
下单卡片生成：优惠计算完成并生成代下单卡片后，系统进入用户反馈流程。
执行步骤
发送优惠结果和下单卡片：
系统将优惠结果和代下单卡片发送给用户。
使用引导话术提醒用户可以点击卡片进行快速下单。
输出
流程结束：用户接收到优惠信息和代下单卡片后，场景2流程结束。
3. 输出指令字段设计
场景2模块在执行完优惠计算后，输出以下信息：

字段名称	字段描述	示例值
商品名称	显示商品的名称	纯棉T恤
原价	显示商品总原价	200元
优惠类型	当前选择的优惠种类	津贴/参团卡
优惠金额	优惠后的减免金额	20元
最终支付金额	计算后的支付金额	180元
用户反馈话术ID	优惠反馈的标准话术ID或具体内容	“已为您计算优惠，点击卡片可下单”
4. 话术模板
4.1 用户反馈话术
数量询问话术：

“请问您要购买几件呢？我帮您看看怎么下单最优惠~”
优惠计算结果：

“已为您生成优惠下单，点击卡片可直接下单，记得及时付款哦~”

PRD 模块4：场景3 - 咨询津贴或参团卡的规则
1. 模块概述
1.1 模块名称
场景3：咨询津贴或参团卡的规则
1.2 模块描述
本模块用于处理用户关于津贴或参团卡的使用规则、领取条件等咨询。系统会在用户提问时调用知识库内容，将咨询的规则信息加载至LLM上下文中，由LLM根据上下文生成相应的规则说明并反馈给用户。此模块为单轮对话，回复用户后即结束流程。
1.3 模块目标
准确回答用户关于津贴或参团卡的相关咨询，提供详细的规则说明，并在回答后立即完成任务。
2. 功能需求
2.1 规则内容管理
触发条件
知识库加载：知识库内存储津贴和参团卡的规则内容，包括领取条件、有效期、使用限制等信息。
规则内容结构
津贴规则：

津贴领取时间及活动：11月1日-11月11日，商城首页有15%津贴抵扣活动，用户可领取999元津贴。
津贴用途：类似于余额，但有有效期，可用于下次购买时抵扣。
抵扣比例：一般可抵扣商品价格的8%至10%，部分活动可达到15%。具体抵扣金额以当时页面显示为准，可能会根据商品生产成本或活动有所调整。
津贴使用规则：
用户账户中有生效中的津贴时，在指定范围内的商品下单时可以使用。
单次/多次使用：用户可以单独购买一件商品使用津贴，也可以选择多件商品一起使用津贴。
叠加使用：多个津贴可叠加用于同一订单。
不可叠加其他活动：津贴不能与其他优惠活动叠加使用。
有效期：津贴在领取后有固定有效期（如3天或活动期间限定），逾期自动失效。
退款规则：
如果在津贴有效期内完成订单退款，津贴仍可使用。
如果津贴已过期（例如3天有效期的津贴在第4天退款），则不能再继续使用。
参团卡规则：

参团卡领取：用户可在指定活动中领取参团卡，领取方式和数量可能因活动不同而有所变化。
使用条件：参团卡适用于团购活动，无最低消费限制。用户使用参团卡购买团购商品时，可享受特别优惠价。
有效期：参团卡领取后需在指定活动有效期内使用，逾期将无法使用。
知识库维护
知识库内容会定期维护，以确保规则信息准确。如规则变更，只需更新知识库内容，无需更改LLM模型。
2.2 咨询类型判断与上下文加载
触发条件
指令接收：当场景3模块接收到意图识别模块下发的指令，且指令类型为“咨询规则”时，系统进入咨询类型判断和上下文加载流程。
执行步骤
咨询类型判断：
系统根据指令中的“咨询内容类别”字段（如津贴规则或参团卡规则）确定用户的咨询类型。
加载知识库内容至上下文：
根据咨询类型，将对应的规则内容（津贴或参团卡）加载至LLM的上下文中。
生成规则说明：
由LLM在上下文信息的基础上生成规则说明，确保内容与知识库一致且符合自然语言表达。
输出
上下文内容：用于LLM生成的规则说明，包括咨询的规则类型和具体内容。
2.3 用户反馈（流程结束）
触发条件
规则说明生成完成：LLM基于上下文生成规则说明后，系统进入用户反馈流程。
执行步骤
发送规则说明：
系统将LLM生成的规则说明反馈给用户，提供明确的规则说明。
结束流程：
发送反馈后，场景3流程结束，无需等待用户进一步操作。
输出
规则说明反馈：系统生成的规则说明发送给用户后，流程即告完成。
3. 输出指令字段设计
场景3模块在执行完规则查询与回复后，输出以下反馈信息：

字段名称	字段描述	示例值
咨询内容类型	当前查询的规则类别	津贴规则/参团卡规则
规则说明内容	LLM生成的规则文本	“津贴有效期至xx日，余额为xxx元”
用户反馈话术ID	反馈的标准话术ID或具体内容	“这是您的津贴使用规则说明…”
4. 话术模板
4.1 用户反馈话术
津贴规则说明：

“您的津贴有效期至 xx 日，当前余额为 xxx 元。津贴适用于全场商品单品满100元可用。如需更多帮助，请随时告诉我！”
参团卡规则说明：

“您的参团卡已激活，可享受团购价优惠。参团卡使用无最低消费限制，需在活动有效期内使用。如需其他帮助，请随时告诉我！”
